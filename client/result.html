<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <!-- My CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='result.css') }}">
    

    <title>Stress Test Results</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- html2canvas Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>

<body>

       <!-- SIDEBAR -->
       <section id="sidebar">
        <a href="#" class="brand">
			<i class='bx bx-badge-check'></i>
            <span class="text">Stress Check</span>
        </a>
        <ul class="side-menu top">
            <li class="active">
                <a href="#">
                    <i class='bx bxs-dashboard' ></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('analytics') }}">
                    <i class='bx bxs-doughnut-chart' ></i>
                    <span class="text">History</span>
                </a>
            </li>
			<li>
                <a href="{{ url_for('recommendation') }}">
					<i class='bx bxs-message-rounded-dots'></i>
                    <span class="text">Recommendation</span>
                </a>
            </li>
			<li>
                <a href="{{ url_for('profile') }}">
                    <i class='bx bxs-user-circle' ></i>
                    <span class="text">My Profile</span>
                </a>
            </li>
        </ul>
        <ul class="side-menu">
			<li>
                <a href="{{ url_for('feedback') }}">
                    <i class='bx bxs-user-pin'></i>
                    <span class="text">Feedback</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('logout') }}" class="logout">
                    <i class='bx bxs-log-out-circle' ></i>
                    <span class="text">Logout</span>
                </a>
            </li>
        </ul>
		<img src="{{ url_for('static', filename='assets/plants.png') }}" alt="Image Description">
    </section>
    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content">
        <!-- NAVBAR -->
        <nav>
            <i class='bx bx-menu' ></i>
            <form action="#">
                <div class="form-input">
                    <input type="search" placeholder="Search...">
                    <button type="submit" class="search-btn"><i class='bx bx-search' ></i></button>
                </div>
            </form>
            <input type="checkbox" id="switch-mode" hidden>
            <label for="switch-mode" class="switch-mode"></label>
        </nav>
        <!-- NAVBAR -->


        <div class="result-container" id="pdf-content">
            
            <h1>Your Stress Test Results</h1>

            <div class="test-info">
                <p><strong>Test-Taker: {{ username }}</strong> <span id="test-taker-name"></span></p>
                <p><strong>Date:</strong> <span id="test-date"></span></p>
            </div>
            
    
            <!-- Progress Circle for Stress Level -->
            <div class="progress-container">
                <svg viewBox="0 0 200 200" width="200" height="200">
                    <!-- Background Circle -->
                    <circle class="progress-background" cx="100" cy="100" r="90" stroke-width="12" />
                    <!-- Progress Circle -->
                    <circle class="progress-circle" cx="100" cy="100" r="90" stroke-width="12" stroke-dasharray="565.48" stroke-dashoffset="100" />
                </svg>
                <div class="progress-text">
                    <h2 id="progress-number">{{ predicted_stress_level }}</h2>
                    <p>Stress Level / 5</p>
                </div>
            </div>

            <!-- Flow of Questionnaire Responses -->
            <div class="flow-responses">
                {% for question_id, response in responses.items() %}
                <div class="flow-card" data-response="{{ response }}" data-context="{{ question_id }}">
                    <div class="flow-card-content">
                        <h4>
                            <!-- Dynamic Question Display based on ID -->
                            {% if question_id == "66f032b953b0c89697587dc3" %}
                                Do you often experience feelings of sadness or depression related to your academic performance?
                            {% elif question_id == "66f032ce53b0c89697587dc4" %}
                                How often do you feel anxious or worried about your academic performance?
                            {% elif question_id == "66f032df53b0c89697587dc5" %}
                                How often do you feel peer pressure affects your academic decisions?
                            {% elif question_id == "66f032ea53b0c89697587dc6" %}
                                How often does poor sleep quality negatively impact your academic performance?
                            {% elif question_id == "66f032f653b0c89697587dc7" %}
                                How often does your reliance on AI tools (e.g., chatbots, educational platforms) impact your academic performance?
                            {% elif question_id == "66f0438553b0c89697587dcc" %}
                                How often do you feel stressed due to family-related issues?
                            {% elif question_id == "66f1862354b2d5c39d77d08a" %}
                                How satisfied are you with your current financial situation as a student?
                            {% elif question_id == "66f1866c54b2d5c39d77d08c" %}
                                I feel that I can rely on my friends when I need help.
                            {% elif question_id == "66f186c754b2d5c39d77d08d" %}
                                How would you rate your access to resources (e.g., textbooks, technology) for your academic success?
                            {% elif question_id == "66f18770f01df7a4f47917e9" %}
                                I often feel stressed because I am unable to get proper rest at home.
                            {% elif question_id == "66f187aff01df7a4f47917ea" %}
                                Long commutes due to traffic congestion add to my daily stress.
                            {% elif question_id == "66f187d0f01df7a4f47917eb" %}
                                How do you feel about the noise level in your living environment during your study time?
                            {% elif question_id == "66f187f3f01df7a4f47917ec" %}
                                Extreme weather conditions (too hot or too cold) make it difficult for me to focus on my academic work.
                            {% elif question_id == "66f1881df01df7a4f47917ed" %}
                                Do you feel confident in your program choice?
                            {% elif question_id == "66f18847f01df7a4f47917ee" %}
                                How would you rate your level of stress related to academic demands such as deadlines, exams, and workload?
                            {% elif question_id == "66f18865f01df7a4f47917ef" %}
                                Do you feel supported by your academic advisors or mentors in managing your academic stress?
                            {% else %}
                                Question not available
                            {% endif %}
                        </h4>
                        <p>{{ response }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        
    
            <h3>Common Stressors</h3>
            {% if common_stressors %}
                <ul class="stressors-list">
                    <div class="stressors-container">
                        {% for stressor in common_stressors %}
                            <div class="stressor-item {{ stressor.class }}">
                                <i class="{{ stressor.icon }}"></i> 
                                <span class="stressor-name">{{ stressor.name }}</span>
                            </div>
                        {% endfor %}
                    </div>
                    
                </ul>
            {% else %}
                <p>No significant stressors identified.</p>
            {% endif %}

            <div class="no-pdf">
                <a href="#" class="cta-btn" onclick="generatePDF()">Generate PDF</a>
            </div>
    
        </div>
        
        

        <script>
            function applyHighlight(response, element, context) {
                // Define colors for each severity level
                const severityColors = {
                    1: '#81C784',  // Light Green for low severity
                    2: '#FFEB3B',  // Yellow for mild severity
                    3: '#FFC107',  // Amber for moderate severity
                    4: '#FF9800',  // Orange for high severity
                    5: '#f44336'   // Red for critical severity
                };
        
                // Mapping for severity levels by context and response
                const mappings = {
                    '66f032b953b0c89697587dc3': {'Never': 1, 'Rarely': 2, 'Sometimes': 3, 'Often': 4, 'Always': 5}, // Sadness
                    '66f032ce53b0c89697587dc4': {'Never': 1, 'Rarely': 2, 'Sometimes': 3, 'Often': 4, 'Always': 5}, // Anxiety
                    '66f032df53b0c89697587dc5': {'Never': 1, 'Rarely': 2, 'Sometimes': 3, 'Often': 4, 'Always': 5}, // Peer Pressure
                    '66f032ea53b0c89697587dc6': {'Never': 1, 'Rarely': 2, 'Sometimes': 3, 'Often': 4, 'Always': 5}, // Sleep Quality
                    '66f032f653b0c89697587dc7': {'Never': 1, 'Rarely': 2, 'Sometimes': 3, 'Often': 4, 'Always': 5}, // AI Tools Impact
                    '66f0438553b0c89697587dcc': {'Never': 1, 'Rarely': 2, 'Sometimes': 3, 'Often': 4, 'Always': 5}, // Family Stress
                    '66f1862354b2d5c39d77d08a': {'Very Satisfied': 1, 'Satisfied': 2, 'Neutral': 3, 'Dissatisfied': 4, 'Very Dissatisfied': 5}, // Financial Satisfaction
                    '66f1866c54b2d5c39d77d08c': {'Strongly Agree': 1, 'Agree': 2, 'Neutral': 3, 'Disagree': 4, 'Strongly Disagree': 5}, // Friends Support
                    '66f186c754b2d5c39d77d08d': {'Excellent': 1, 'Good': 2, 'Adequate': 3, 'Poor': 4, 'Very Poor': 5}, // Resources Access
                    '66f18770f01df7a4f47917e9': {'Strongly Disagree': 1, 'Disagree': 2, 'Neutral': 3, 'Agree': 4, 'Strongly Agree': 5}, // Home Stress
                    '66f187aff01df7a4f47917ea': {'Not at all': 1, 'A little': 2, 'Moderately': 3, 'Significantly': 4, 'Extremely': 5}, // Commute Stress
                    '66f187d0f01df7a4f47917eb': {'Very Manageable': 1, 'Manageable': 2, 'Neutral': 3, 'Disturbing': 4, 'Very Disturbing': 5}, // Noise Level
                    '66f187f3f01df7a4f47917ec': {'Strongly Disagree': 1, 'Disagree': 2, 'Neutral': 3, 'Agree': 4, 'Strongly Agree': 5}, // Weather Conditions
                    '66f1881df01df7a4f47917ed': {'Yes': 1, 'No': 5}, // Program Confidence
                    '66f18847f01df7a4f47917ee': {'Not at all': 1, 'A little': 2, 'Moderately': 3, 'Significantly': 4, 'Extremely': 5}, // Academic Stress
                    '66f18865f01df7a4f47917ef': {'Completely': 1, 'Very Much': 2, 'Moderately': 3, 'Somewhat': 4, 'Not at all': 5} // Advisor Support
                };
                
        
                // Determine severity based on context and response
                const severity = mappings[context]?.[response] || 0;
        
                if (severity > 0) {
                    element.style.borderLeftColor = severityColors[severity];
                } else {
                    element.style.borderLeftColor = 'transparent'; // Default color if no severity
                }
            }
        
            // Apply the function to each card with data-response and data-context attributes
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.flow-card').forEach(card => {
                    const response = card.getAttribute('data-response');
                    const context = card.getAttribute('data-context');
                    applyHighlight(response, card, context);
                });
            });
            
            function setProgress(level) {
                const progressCircle = document.querySelector('.progress-circle');
                const radius = progressCircle.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (level / 5 * circumference);
            
                const levelColors = [
                    "#4CAF50", // Level 1: Green (Low stress)
                    "#FFC107", // Level 2: Yellow (Moderate stress)
                    "#FF9800", // Level 3: Orange (High stress)
                    "#FF5722", // Level 4: Dark Orange (Very high stress)
                    "#F44336"  // Level 5: Red (Extreme stress)
                ];
            
                progressCircle.style.strokeDashoffset = offset;
                progressCircle.style.stroke = levelColors[level - 1];
            }
            
            const currentStressLevel = parseInt("{{ predicted_stress_level }}");
            setProgress(currentStressLevel);
            
            // Function to toggle the menu on mobile
            function toggleMenu() {
                const menu = document.querySelector('.navbar-menu');
                const hamburger = document.querySelector('.hamburger');
                menu.classList.toggle('active');
                hamburger.classList.toggle('active');
            }

            async function generatePDF() {
                try {
                    const element = document.getElementById('pdf-content');
            
                    // Apply PDF-specific styling
                    element.classList.add('pdf-mode');
            
                    // Retrieve the stress level text from the existing display
                    const stressLevelElement = document.getElementById('progress-number');
                    const predictedStressLevel = stressLevelElement ? stressLevelElement.textContent : "N/A";
            
                    // Hide progress circle and show plain text for PDF
                    const progressCircle = document.querySelector('.progress-container');
                    const stressText = document.createElement('div');
                    stressText.className = 'stress-level-text';
                    stressText.innerHTML = `<h2>Stress Level: ${predictedStressLevel} / 5</h2>`;
                    progressCircle.replaceWith(stressText);
            
                    const options = {
                        margin: 10,
                        filename: 'Stress_Test_Results.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 3,
                            useCORS: true
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        },
                        pagebreak: { mode: ['css', 'avoid-all'] }
                    };
            
                    // Generate the PDF with html2pdf.js
                    await html2pdf().set(options).from(element).save();
            
                    // Revert to original layout after PDF generation
                    stressText.replaceWith(progressCircle);
                    element.classList.remove('pdf-mode');
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    alert("An error occurred while generating the PDF. Please try again.");
                }
            }

            // Format the date to appear as "Month Day, Year"
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const currentDate = new Date().toLocaleDateString(undefined, options);

           
            document.getElementById("test-date").innerText = currentDate;
            
        </script>            
        
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    

</body>
</html>
