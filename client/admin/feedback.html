<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<!-- My CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='admin/styles.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='admin/admin_styles/toast.css') }}">

	<title>Feedback</title>

	<!-- Modal for Viewing Feedback -->
	<div id="feedbackViewModal" class="feedback-modal">
		<div class="feedback-modal-content">
			<!-- Close button now inside the modal-content -->
			<span class="feedback-close-button" onclick="closeModal('feedbackViewModal')">&times;</span>
			<h2 class="modal-title">Feedback Details</h2>
			<p><strong>Username:</strong> <span id="modalUsername"></span></p>
			<p><strong>Date & Time:</strong> <span id="modalDate"></span></p>
			<p><strong>Feedback:</strong></p>
			<p id="modalFeedback"></p>
		</div>
	</div>


	<!-- Modal for delete confirmation -->
	<div id="deleteConfirmationModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeModal('deleteConfirmationModal')">&times;</span>
			<h3>Confirm Delete</h3>
			<p id="deleteMessage">Are you sure you want to delete the feedback from <strong id="modalUsernameDelete"></strong>?</p>
			<button class="btnClose" onclick="closeModal('deleteConfirmationModal')">Cancel</button>
			<button class="btnConfirm" onclick="confirmDelete()">Yes</button>
		</div>
	</div>



<!-- Styles -->
<style>
   /* Feedback modal background */
	.feedback-modal {
		display: none; /* Initially hidden */
		position: fixed;
		z-index: 3000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5); /* Dark overlay */
		overflow: auto;
		padding-top: 100px; /* Space from top */
	}

	/* Feedback modal content */
	.feedback-modal-content {
		background-color: #FFFFFF;
		margin: auto;
		padding: 20px;
		border: 1px solid #ddd;
		width: 80%;
		max-width: 600px;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		border-radius: 10px;
		position: absolute; /* Use absolute positioning to center */
		top: 50%; /* Center vertically */
		left: 50%; /* Center horizontally */
		transform: translate(-50%, -50%); /* Adjust to perfectly center */
		z-index: 3001; /* Make sure modal is above the overlay */
	}

	/* Close button styling */
	.feedback-close-button {
		color: #1A4D2E;
		font-size: 30px;
		font-weight: bold;
		position: absolute; /* Positioned relative to the modal content */
		top: 10px;
		right: 15px;
		cursor: pointer;
		transition: 0.3s;
	}

	.feedback-close-button:hover {
		color: #7ABA78;
	}

	/* Modal title styling */
	.modal-title {
		font-size: 24px;
		color: #1A4D2E;
		margin-bottom: 20px;
	}

	p {
		font-family: Arial, sans-serif;
		line-height: 1.6;
		color: #475569;
	}

	strong {
		color: #1A4D2E;
	}

	#modalFeedback {
		background-color: #F2F2F2;
		padding: 15px;
		border-radius: 8px;
		margin-top: 10px;
		color: #475569;
		font-style: italic;
	}

	#modalUsername, #modalDate {
		color: #55b752;
	}

</style>

</head>
<body>

	<!-- SIDEBAR -->
	<section id="sidebar">
		<nav>
		<a href="#" class="brand">
			<i class='bx bx-badge-check'></i>
			<span class="text">Stress Check</span>
		</a>
		<ul class="side-menu top">
			<li >
				<a href="{{ url_for('admin_dashboard') }}">
					<i class='bx bxs-dashboard' ></i>
					<span class="text">Dashboard</span>
				</a>
			</li>
			<li>
				<a href="{{ url_for('management') }}">
					<i class='bx bxs-user-detail'></i>
					<span class="text">User Management</span>
				</a>
			</li>
			<li>
				<a href="{{ url_for('data') }}">
					<i class='bx bxs-data'></i>
					<span class="text">Data Management</span>
				</a>
			</li>
			<li>
				<a href="{{ url_for('edit_recommendation') }}">
					<i class='bx bxs-check-circle'></i>
					<span class="text">Recommendation</span>
				</a>
			</li>
			<li class="active">
				<a href="{{ url_for('admin_feedback') }}">
					<i class='bx bxs-user-pin'></i>
					<span class="text">User Feedback</span>
				</a>
			</li>
		</ul>
		<ul class="side-menu">
			<li>
				<a href="{{ url_for('login') }}" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Logout</span>
				</a>
			</li>
		</ul>
		</nav>
	</section>
	<!-- SIDEBAR -->

	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class="bx bx-menu"></i>
			<form action="#"></form>
		</nav>
		<!-- NAVBAR -->


	<!-- MAIN -->
	<main>
		<div class="head-title">
			<div class="left">
				<h1>User Feedbacks</h1>
				<ul class="breadcrumb">
					<li>
						<a href="{{ url_for('admin_dashboard', username=username) }}">Dashboard</a>
					</li>
					<li><i class='bx bx-chevron-right'></i></li>
					<li>
						<a class="active" href="#">User Feedback</a>
					</li>
				</ul>
			</div>
		</div>

		<div id="toast"></div>
	
		<div class="table-container">
			<table class="feedback-table">
				<thead>
					<tr>
						<th>Username</th>
						<th>Feedback</th>
						<th>Date & Time</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for feedback in feedback_data %}
					<tr id="feedback-row-{{ feedback._id }}">
						<td>{{ feedback.username }}</td>
						<td>{{ feedback.feedback }}</td>
						<td>{{ feedback.timestamp.strftime('%d/%m/%Y, %H:%M:%S') }}</td>
						<td>
							<button class="btn-icon view-feedback" title="View" data-feedback="{{ feedback.feedback }}" data-username="{{ feedback.username }}" data-date="{{ feedback.timestamp }}">
								<i class='bx bx-show'></i>
							</button>
							<button class="btn-icon delete-feedback" title="Delete" data-id="{{ feedback._id }}">
								<i class='bx bx-trash'></i>
							</button>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</main>
	<!-- MAIN -->
</section>
<!-- CONTENT -->
		<!-- Modal for delete confirmation -->

	

		<script>
		// Variables to hold the feedback ID and modal elements
		let feedbackIdToDelete = null;
		const modalUsername = document.getElementById('modalUsername');
		const modalDate = document.getElementById('modalDate');
		const modalUsernameDelete = document.getElementById('modalUsernameDelete');

		// Function to open the modal for viewing feedback
		function openModal(username, date, feedback) {
			const formattedDate = new Date(date).toLocaleString('en-GB', {
				year: 'numeric',
				month: 'numeric',
				day: 'numeric',
				hour: 'numeric',
				minute: 'numeric',
				second: 'numeric',
				hour12: false
			});

			// Insert the details into the view feedback modal
			modalUsername.innerText = username;
			modalDate.innerText = formattedDate;
			modalFeedback.innerText = feedback;

			document.getElementById('feedbackViewModal').style.display = 'block';
		}

		// Function to close the modal
		function closeModal(modalId) {
			document.getElementById(modalId).style.display = 'none';
		}

		function openDeleteModal(feedbackId, username) {
			feedbackIdToDelete = feedbackId;  // Store the ID to delete
			console.log("Feedback ID to delete:", feedbackIdToDelete); // Debugging line
		
			modalUsernameDelete.innerText = username;
		
			const modal = document.getElementById('deleteConfirmationModal');
			modal.style.display = 'flex';
			modal.style.opacity = '1';
			modal.style.visibility = 'visible';
		}
		
		


		  function confirmDelete() {
			if (feedbackIdToDelete) {
				fetch('/admin/feedback/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-Requested-With': 'XMLHttpRequest'
					},
					body: JSON.stringify({ feedback_id: feedbackIdToDelete })
				})
				.then(response => response.json())
				.then(data => {
					console.log("Server Response:", data); // Debugging line
					if (data.success) {
						// Successfully deleted
						document.getElementById(`feedback-row-${feedbackIdToDelete}`).remove();
						showToast(data.success, 'success');
					} else if (data.error) {
						// Error occurred
						showToast(data.error, 'error');
					}
					closeModal('deleteConfirmationModal');
				})
				.catch(error => {
					console.error('Fetch error:', error);
					showToast('An unexpected error occurred.', 'error');
				});
			}
		}
		
		
		

		// Event listener for delete buttons
		document.addEventListener('DOMContentLoaded', function() {
			const deleteButtons = document.querySelectorAll('.delete-feedback');
			deleteButtons.forEach(button => {
				button.addEventListener('click', function() {
					const feedbackId = this.getAttribute('data-id');
					const username = this.closest('tr').querySelector('td:nth-child(1)').textContent;
					openDeleteModal(feedbackId, username);
				});
			});

			const viewButtons = document.querySelectorAll('.view-feedback');
			viewButtons.forEach(button => {
				button.addEventListener('click', function() {
					const username = this.getAttribute('data-username');
					const date = this.getAttribute('data-date');
					const feedback = this.getAttribute('data-feedback');
					openModal(username, date, feedback);
				});
			});
		});

		function showToast(message, type) {
			const toast = document.getElementById('toast');
			if (!toast) {
				console.error('Toast element not found!');
				return;
			}
			
			if (!message) {
				console.error('Toast message is undefined!');
				return;
			}
		
			toast.innerText = message;
		
			// Reset classes and add type class
			toast.className = '';
			toast.classList.add('show', type);
		
			// Auto-hide toast
			setTimeout(() => {
				toast.classList.add('fade-out');
				setTimeout(() => {
					toast.classList.remove('show', 'fade-out');
					toast.innerText = ''; // Clear message after hiding
				}, 500); // Fade-out duration
			}, 3000); // Show duration
		}
		
        


	</script>

	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script src="{{ url_for('static', filename='admin/script.js') }}"></script>

</body>
</html>
